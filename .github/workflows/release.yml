name: Build Windows Target (Legacy Go)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # 1. 模拟 GOPATH 结构：将代码检出到 src/ScreenStreamer
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: src/ScreenStreamer

      # 2. 安装 MSYS2 及 C 语言依赖
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-libjpeg-turbo
            mingw-w64-x86_64-ffmpeg
            pkg-config

      # 3. 设置 Go 环境
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      # 4. 编译（核心难点在于 GOPATH 和 CGO 配置）
      - name: Build
        shell: msys2 {0}
        run: |
          # 获取当前绝对路径作为 GOPATH
          WORKSPACE=$(pwd)
          export GOPATH=$WORKSPACE:$WORKSPACE/src/ScreenStreamer/lib
          
          # 关键：关闭 Go Modules 模式，启用 CGO
          export GO111MODULE=off
          export CGO_ENABLED=1
          
          # 进入源码目录
          cd src/ScreenStreamer
          
          echo "Building mjpeg..."
          go build -o ../../mjpeg.exe ./cmd/mjpeg/mjpeg.go
          
          echo "Building rtmp..."
          go build -o ../../rtmp.exe ./cmd/rtmp/rtmp.go
          
          echo "Building get_active_window..."
          go build -o ../../get_active_window.exe ./cmd/get_active_window/get_active_window.go

      # 5. 收集编译产物
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ScreenStreamer-Windows
          path: |
            *.exe
